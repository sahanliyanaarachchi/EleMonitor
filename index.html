<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Elephant Alert - Sri Lanka Map Only</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100%;
      opacity: 0;
      transition: opacity 1s ease-in;
    }

    #map.loaded {
      opacity: 1;
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 1.2rem;
      z-index: 9999;
      flex-direction: column;
    }

    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    #button-container {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    button {
      padding: 10px 18px;
      background-color: red;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease;
    }

    button:disabled {
      background-color: #aa0000;
      cursor: not-allowed;
    }

    #select-location-btn.active,
    #drive-mode-btn.active {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 123, 255, 0.7);
    }
  </style>
</head>
<body>
  <div id="button-container">
    <button id="live-location-btn">Live Location</button>
    <button id="select-location-btn">Select Location</button>
    <button id="drive-mode-btn">Drive Mode</button>
  </div>

  <div id="loading">
    <div class="spinner"></div>
    <div>Loading map, please wait...</div>
  </div>

  <div id="map"></div>

  <script
    src="https://unpkg.com/leaflet/dist/leaflet.js"
    crossorigin=""
  ></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onValue,
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBPM55I08UVYhUm8XwETLlukc0btlKLE6Q",
      authDomain: "elephant-alert-68626.firebaseapp.com",
      databaseURL: "https://elephant-alert-68626-default-rtdb.firebaseio.com",
      projectId: "elephant-alert-68626",
      storageBucket: "elephant-alert-68626.firebasestorage.app",
      messagingSenderId: "669608211278",
      appId: "1:669608211278:web:11882bbe5bc29910e5641f",
      measurementId: "G-WFZGXHZHHP",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const southWest = L.latLng(5.8371, 79.6506);
    const northEast = L.latLng(10.0919, 81.8807);
    const sriLankaBounds = L.latLngBounds(southWest, northEast);

    const map = L.map("map", {
      maxBounds: sriLankaBounds,
      maxBoundsViscosity: 1.0,
      minZoom: 7,
      maxZoom: 15,
      attributionControl: false,
    }).setView([7.8731, 80.7718], 8);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    const loadingDiv = document.getElementById("loading");
    const liveLocationBtn = document.getElementById("live-location-btn");
    const selectLocationBtn = document.getElementById("select-location-btn");
    const driveModeBtn = document.getElementById("drive-mode-btn");

    const elephantIcon = L.divIcon({
      html: `<div style="
        background-color: red; 
        color: white; 
        font-size: 24px; 
        width: 40px; 
        height: 40px; 
        text-align: center; 
        border-radius: 50%; 
        line-height: 40px;
        box-shadow: 0 0 5px rgba(0,0,0,0.5);
        ">
          üêò
        </div>`,
      className: "",
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40],
    });

    const driverIcon = L.divIcon({
      html: `<div style="
        background-color: crimson;
        opacity: 0.8;
        border: 2px solid white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        box-shadow: 0 0 10px crimson;
      "></div>`,
      className: "",
      iconSize: [30, 30],
      iconAnchor: [15, 15],
    });

    function isInsideSriLanka(lat, lng) {
      return sriLankaBounds.contains([lat, lng]);
    }

    // Haversine formula to calculate distance in km between 2 lat/lng points
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radius of the earth in km
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) *
          Math.cos(deg2rad(lat2)) *
          Math.sin(dLon / 2) *
          Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // Distance in km
    }

    function deg2rad(deg) {
      return deg * (Math.PI / 180);
    }

    let selectLocationMode = false;
    let driveMode = false;
    let watchId = null;
    let driverMarker = null;

    // To store elephant markers and their leaflet marker instances for popup control
    let elephantMarkers = [];

    function disableSelectLocationMode() {
      selectLocationMode = false;
      selectLocationBtn.classList.remove("active");
      selectLocationBtn.textContent = "Select Location";
      liveLocationBtn.disabled = false;
      driveModeBtn.disabled = false;
      map.getContainer().style.cursor = "";
      map.off("click", onMapClick);
    }

    function enableSelectLocationMode() {
      selectLocationMode = true;
      selectLocationBtn.classList.add("active");
      selectLocationBtn.textContent = "Click on Map to Select Location";
      liveLocationBtn.disabled = true;
      driveModeBtn.disabled = true;
      map.getContainer().style.cursor = "crosshair";
      map.on("click", onMapClick);
    }

    function onMapClick(e) {
      const { lat, lng } = e.latlng;

      if (!isInsideSriLanka(lat, lng)) {
        alert("Selected location is outside Sri Lanka. Please select inside Sri Lanka.");
        return;
      }

      push(ref(db, "elephants"), {
        latitude: lat,
        longitude: lng,
        timestamp: Date.now(),
      });

      alert("Elephant location tagged at selected position!");

      disableSelectLocationMode();
    }

    liveLocationBtn.addEventListener("click", () => {
      if (selectLocationMode) disableSelectLocationMode();
      if (driveMode) {
        alert("Turn off Drive Mode before using Live Location.");
        return;
      }

      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }

      liveLocationBtn.disabled = true;
      liveLocationBtn.textContent = "Getting Location...";

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          if (!isInsideSriLanka(lat, lng)) {
            alert("Your location is outside Sri Lanka. Cannot tag elephant here.");
            liveLocationBtn.disabled = false;
            liveLocationBtn.textContent = "Live Location";
            return;
          }

          push(ref(db, "elephants"), {
            latitude: lat,
            longitude: lng,
            timestamp: Date.now(),
          });

          alert("Elephant location tagged at your current position!");

          liveLocationBtn.disabled = false;
          liveLocationBtn.textContent = "Live Location";
        },
        (error) => {
          alert("Unable to retrieve your location: " + error.message);
          liveLocationBtn.disabled = false;
          liveLocationBtn.textContent = "Live Location";
        }
      );
    });

    driveModeBtn.addEventListener("click", () => {
      if (driveMode) {
        driveMode = false;
        driveModeBtn.classList.remove("active");
        driveModeBtn.textContent = "Drive Mode";

        liveLocationBtn.disabled = false;
        selectLocationBtn.disabled = false;

        map.getContainer().style.cursor = "";

        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }

        if (driverMarker) {
          map.removeLayer(driverMarker);
          driverMarker = null;
        }
      } else {
        if (!navigator.geolocation) {
          alert("Geolocation is not supported by your browser.");
          return;
        }

        driveMode = true;
        driveModeBtn.classList.add("active");
        driveModeBtn.textContent = "Drive Mode ON";

        liveLocationBtn.disabled = true;
        selectLocationBtn.disabled = true;

        map.getContainer().style.cursor = "progress";

        watchId = navigator.geolocation.watchPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            if (!isInsideSriLanka(lat, lng)) {
              console.warn("Driver location outside Sri Lanka bounds.");
              return;
            }

            if (!driverMarker) {
              driverMarker = L.marker([lat, lng], { icon: driverIcon }).addTo(map);
              map.setView([lat, lng], 14);
            } else {
              driverMarker.setLatLng([lat, lng]);
            }

            // Check for elephants within 5 km radius
            elephantMarkers.forEach(({ data, marker }) => {
              const dist = getDistanceFromLatLonInKm(
                lat,
                lng,
                data.latitude,
                data.longitude
              );
              if (dist <= 5) {
                // Open popup automatically when close
                marker.openPopup();

                // Optionally, alert or console log
                // alert(`Warning: Elephant within 5 km (${dist.toFixed(2)} km)`);
              } else {
                marker.closePopup();
              }
            });
          },
          (error) => {
            alert("Drive mode GPS error: " + error.message);
          },
          {
            enableHighAccuracy: true,
            maximumAge: 10000,
            timeout: 10000,
          }
        );
      }
    });

    // Update elephant markers on DB change
    onValue(ref(db, "elephants"), (snapshot) => {
      // Remove old elephant markers
      elephantMarkers.forEach(({ marker }) => {
        map.removeLayer(marker);
      });
      elephantMarkers = [];

      const data = snapshot.val();
      if (data) {
        Object.values(data).forEach((elephant) => {
          if (isInsideSriLanka(elephant.latitude, elephant.longitude)) {
            const marker = L.marker([elephant.latitude, elephant.longitude], {
              icon: elephantIcon,
            }).addTo(map);

            marker.bindPopup("üêò Elephant reported here");

            elephantMarkers.push({ data: elephant, marker });
          }
        });
      }

      loadingDiv.style.display = "none";
      document.getElementById("map").classList.add("loaded");
    });
  </script>
</body>
</html>
